# 요구사항 문서

## 소개

파트너 확인 자동화 시스템은 고객 문의를 자동으로 분류하고, 제휴점(파트너)에게 SMS 링크를 전송하여 로그인 없이 간단한 클릭만으로 응답을 수집하는 서버리스 솔루션입니다. 전체 프로세스는 완전 자동화되며, 운영자는 실시간으로 진행 상태를 모니터링할 수 있습니다.

## 용어 정의

- **시스템**: 파트너 확인 자동화 시스템
- **고객**: 서비스를 이용하는 최종 고객
- **파트너**: 제휴점 사장님 또는 담당자
- **예약번호**: 고객의 예약을 식별하는 고유 번호
- **예약 데이터베이스**: 예약번호, 고객정보, 파트너정보를 저장하는 데이터 저장소
- **오케스트레이터**: 전체 워크플로우를 조율하는 Lambda 함수
- **확인 링크**: 파트너가 응답할 수 있는 1회용 서명된 URL
- **요청**: 고객 문의에 대한 파트너 확인 요청 건
- **관리자 대시보드**: 운영자가 요청 상태를 모니터링하는 관리 페이지
- **태스크 토큰**: Step Functions Callback 패턴에서 사용하는 재개 토큰
- **서명 토큰**: HMAC-SHA256으로 서명된 1회용 인증 토큰

## 요구사항

### 요구사항 1

**사용자 스토리:** 고객으로서, 웹 채팅 인터페이스를 통해 예약번호와 함께 문의를 제출하여 내 요청이 자동으로 분류되고 적절한 파트너에게 전달되기를 원합니다

#### 인수 기준

1. WHEN 고객이 웹 채팅 인터페이스를 통해 텍스트와 예약번호를 제출하면, THE 시스템 SHALL ko-KR 로케일로 Amazon Lex V2를 호출하여 인텐트를 분류한다
2. WHEN Amazon Lex V2가 인텐트와 슬롯을 성공적으로 추출하면, THE 시스템 SHALL 예약번호 슬롯이 포함되어 있는지 검증한다
3. IF 예약번호 슬롯이 누락되었으면, THEN THE 시스템 SHALL 고객에게 예약번호 입력을 요청하는 메시지를 반환한다
4. WHEN 예약번호가 확인되면, THE 시스템 SHALL 고유한 요청 ID를 생성한다
5. WHEN 요청 ID가 생성되면, THE 시스템 SHALL DynamoDB에 "Created" 상태로 요청 레코드를 저장한다
6. IF Amazon Lex V2가 인텐트 분류에 실패하면, THEN THE 시스템 SHALL 3초 이내에 고객에게 오류 메시지를 반환한다
7. THE 시스템 SHALL 최소 3가지 인텐트 유형을 지원한다: 예약 변경, 트러블 신고, 부가 서비스 요청

### 요구사항 2

**사용자 스토리:** 시스템으로서, 예약번호와 고객정보를 기반으로 예약 데이터베이스에서 담당 파트너를 조회하여 올바른 파트너에게 확인 요청을 전달하기를 원합니다

#### 인수 기준

1. WHEN 요청이 생성되면, THE 시스템 SHALL 예약번호를 사용하여 예약 데이터베이스를 조회한다
2. WHEN 예약 데이터베이스를 조회할 때, THE 시스템 SHALL 예약번호와 고객 연락처를 매칭 조건으로 사용한다
3. IF 예약번호가 예약 데이터베이스에 존재하지 않으면, THEN THE 시스템 SHALL 요청 상태를 "Failed"로 업데이트하고 고객에게 "예약을 찾을 수 없습니다" 오류 메시지를 반환한다
4. IF 고객 연락처가 예약 정보와 일치하지 않으면, THEN THE 시스템 SHALL 요청 상태를 "Failed"로 업데이트하고 고객에게 "예약 정보가 일치하지 않습니다" 오류 메시지를 반환한다
5. WHEN 예약이 성공적으로 조회되면, THE 시스템 SHALL 예약 레코드에서 파트너 ID와 파트너 전화번호를 추출한다
6. WHEN 파트너 정보가 추출되면, THE 시스템 SHALL 요청 레코드에 파트너 ID, 파트너 전화번호, 예약 세부정보를 저장한다

### 요구사항 3

**사용자 스토리:** 파트너로서, 로그인 없이 간단한 SMS 링크를 받아 고객 요청에 빠르게 응답하기를 원합니다

#### 인수 기준

1. WHEN 오케스트레이터가 확인 링크를 생성하면, THE 시스템 SHALL 요청 ID, 파트너 ID, 만료 타임스탬프, scope "confirm"을 포함하는 페이로드로 서명 토큰을 생성한다
2. WHEN 서명 토큰을 생성할 때, THE 시스템 SHALL 환경 변수에서 가져온 비밀 키로 HMAC-SHA256 알고리즘을 사용한다
3. WHEN 서명 토큰이 생성되면, THE 시스템 SHALL 생성 시점으로부터 10분의 만료 시간을 설정한다
4. WHEN SMS가 전송되면, THE 시스템 SHALL "https://confirm.example/r/{token}" 형식으로 확인 링크를 포함한다
5. WHEN Amazon SNS가 SMS를 발행하면, THE 시스템 SHALL DynamoDB에서 요청 상태를 "SMS Sent"로 업데이트한다

### 요구사항 4

**사용자 스토리:** 파트너로서, SMS 링크를 클릭하여 간단한 확인 페이지를 보고 복잡한 탐색 없이 수락, 거절 또는 대안 시간으로 응답하기를 원합니다

#### 인수 기준

1. WHEN 파트너가 확인 링크를 클릭하면, THE 시스템 SHALL 서명 토큰의 서명과 만료를 검증한다
2. IF 서명 토큰이 유효하지 않거나 만료되었으면, THEN THE 시스템 SHALL 오류 페이지를 표시하고 "Failed" 이벤트를 기록한다
3. WHEN 서명 토큰이 유효하면, THE 시스템 SHALL DynamoDB에서 요청 세부 정보를 가져와 확인 페이지에 표시한다
4. THE 시스템 SHALL 정확히 3가지 응답 옵션을 제공한다: 수락, 거절, 대안 시간 제안
5. WHEN 파트너가 링크를 클릭하면, THE 시스템 SHALL DynamoDB에 타임스탬프와 함께 "Opened" 이벤트를 기록한다

### 요구사항 5

**사용자 스토리:** 파트너로서, 한 번의 클릭으로 응답을 제출하여 여러 단계 없이 빠르게 확인을 완료하기를 원합니다

#### 인수 기준

1. WHEN 파트너가 응답 옵션을 선택하고 제출하면, THE 시스템 SHALL 서명 토큰이 이미 사용되지 않았는지 검증한다
2. WHEN 응답이 유효하면, THE 시스템 SHALL 태스크 토큰과 함께 Step Functions SendTaskSuccess API를 호출한다
3. WHEN SendTaskSuccess가 호출되면, THE 시스템 SHALL 재사용을 방지하기 위해 DynamoDB에서 서명 토큰을 사용됨으로 표시한다
4. WHEN 응답이 기록되면, THE 시스템 SHALL 파트너 결정과 타임스탬프와 함께 요청 상태를 "Responded"로 업데이트한다
5. IF 서명 토큰이 이미 사용되었으면, THEN THE 시스템 SHALL "링크가 이미 사용되었습니다" 오류 메시지를 반환한다

### 요구사항 6

**사용자 스토리:** 시스템으로서, 전체 확인 워크플로우를 자동으로 오케스트레이션하여 수동 개입 없이 요청을 처리하기를 원합니다

#### 인수 기준

1. WHEN 오케스트레이터가 워크플로우를 시작하면, THE 시스템 SHALL Callback 패턴으로 Step Functions 실행을 생성한다
2. WHEN Step Functions가 WaitPartner 상태에 도달하면, THE 시스템 SHALL 300초 타임아웃으로 태스크 토큰 콜백을 대기한다
3. IF 300초 이내에 파트너 응답이 수신되지 않으면, THEN THE 시스템 SHALL 타임아웃 상태로 전환한다
4. WHEN 타임아웃이 발생하면, THE 시스템 SHALL 요청 상태를 "Timeout"으로 업데이트하고 고객 알림 생성을 진행한다

### 요구사항 7

**사용자 스토리:** 고객으로서, 내 요청 결과에 대한 자동 알림을 받아 요청이 확인되었는지 또는 대안 조치가 필요한지 알기를 원합니다

#### 인수 기준

1. WHEN 파트너가 응답하거나 타임아웃이 발생하면, THE 시스템 SHALL Amazon Bedrock을 호출하여 고객 알림 메시지를 생성한다
2. WHEN Bedrock을 호출할 때, THE 시스템 SHALL 프롬프트에 요청 세부 정보와 파트너 응답을 포함한다
3. THE 시스템 SHALL 한국어로 알림 메시지를 생성한다
4. WHEN 알림이 생성되면, THE 시스템 SHALL 고객 UI에 표시한다

### 요구사항 8

**사용자 스토리:** 개발자로서, 시스템이 완전히 서버리스로 구성되어 자동으로 확장되고 운영 오버헤드를 최소화하기를 원합니다

#### 인수 기준

1. THE 시스템 SHALL 모든 REST 엔드포인트에 Amazon API Gateway HTTP API를 사용한다
2. THE 시스템 SHALL 모든 컴퓨팅 작업에 AWS Lambda 함수를 사용한다
3. THE 시스템 SHALL Callback 패턴으로 워크플로우 오케스트레이션에 AWS Step Functions를 사용한다
4. THE 시스템 SHALL 단일 테이블 설계로 기본 데이터 저장소로 Amazon DynamoDB를 사용한다
5. THE 시스템 SHALL Static Website Hosting이 활성화된 Amazon S3에 정적 웹 페이지를 호스팅한다
